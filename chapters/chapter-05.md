前端工程師必會的六個偵錯技能
===

> 我還是一個野生程式設計師的時候，不會 Debug，只會傻傻地寫一句句 std::count。即使是在今天，有些時候我也會這樣做：打一個 console.log，然後看看結果是不是和預期的一樣。如果不是和預期一樣，就修改一下程式碼，重新整理一下瀏覽器。這得虧是 JavaScript 是一門動態語言，可以很快的看到執行的結果。

**前言**： 本章裡，主要介紹如何偵錯前端應用——基本的偵錯： HTML、CSS 和 JavaScript；使用網路工具對 API 進行測試；對移動裝置進行偵錯：使用瀏覽器的模擬器、真機、iOS 模擬；對網站的效能進行偵錯等內容。

偵錯（Debug）在[維基百科](https://zh.wikipedia.org/wiki/%E8%B0%83%E8%AF%95)上的定義是：是發現和減少計算機程式或電子儀器裝置中程式錯誤的一個過程。

多數時候，偵錯是為了找到程式碼中的錯誤，並具體定位到錯誤的地方。幸運的是，現在的前端框架都比較人性化了，可以和大部分的後臺框架一樣，提示程式碼中出錯的地方。這時，我們只需要藉助於瀏覽器的偵錯，找到錯誤的行數，並檢視錯誤的原因。

有些時候，我們偵錯是為下一步程式設計，提供一些理論依據。如在應用執行的時候，我們可以使用瀏覽器打個斷點，並在 Console 中輸入程式碼偵錯下一步要做的事。最後，再將這些程式碼複製到 IDE 或者編輯器上即可。

我的偵錯入門
---

與我的程式設計經驗相比，我學會 Debug 的時間比較晚。我是在大學裡學會 Debug 的，當時在為一個支援線上偵錯的晶片寫程式。對於嵌入式開發而言，不同的晶片都會有不同的 IDE。有的 IDE 可以支援偵錯，有的則不行；有的 IDE 則連基本的語法高亮都沒有。

對於支援線上偵錯的開發環境來說，我們只需要打一兩個斷點，看程式是否執行到這個邏輯，又或者是按下“下一步”按鈕，看程式執行到哪些地方，並實時的預覽變數的值。

對於不支援線上偵錯的晶片來說，沒有螢幕也就不能使用 printf 來輸出結果。只能通過 SD 卡里的檔案系統來寫入日記，再計算機上讀取日記來分析。這隻的是一件麻煩的事，對於沒有 SD 卡的開發板來說，還需要騰出幾個指令碼接上 SD 卡。也有些晶片是不能使用 SD 卡的，這時我們就只能依靠於想象力來偵錯。

在今天開發 Web 應用時，上述的內容都只是基本的偵錯。有一些能支援更高階的偵錯——如評估表示式，即利用當前的變數值，來實時計算，並慢慢完成下一步的程式碼。最初，我是在用 Intellij Idea 寫程式的時候，學會在後臺程式設計時使用 ``evaluate expression``。它可以在排程程式碼的時候，我們可以邊實現功能。

後來，我才醒悟到在前端領域，這是基本的偵錯功能，在 Chrome、Safari 這些現代的瀏覽器上都能這樣做。

與一般的單機應用相比，讓 Web 應用不能如期執行有更多的原因。並且相當多的原因與程式碼無關，如：

 - 服務在執行中崩潰，沒有向前端返回資料，前端只能使用超時來處理。這時，我們可以通過瀏覽器中的 Network 來知道這件事。
 - 本地開發的時候，URL 的編碼都是沒有問題的，而線上上則出了問題。經過一系列復現和排察後，才發現問題出在 Nginx 上的轉義上。
 - 等等

這時，我們就需要使用更好的工具來幫助開發。

基本偵錯技巧：實時偵錯
---

開始之前，我們需要開啟 Chrome 瀏覽器的偵錯視窗。除了點滑鼠右鍵，然後選擇“審查元素”之外，還可以：

 - Windows / Linux 作業系統，使用 Ctrl + Shift + I 快捷鍵開啟開發人員工具
 - Mac OS 作業系統，使用 Comand + Option + I  快捷鍵開啟開發人員工具

這個偵錯視窗看上去，有點高大上：

![認識一下偵錯視窗](../images/basic-inspect.png)

圖中左上角的兩個圖示，分別是：

 - **審查元素**。可以讓我們檢查頁面上的 DOM 元素，瞭解 DOM 結構
 - **裝置工具欄開關**。在裝置工具欄裡，可以模擬不同的移動裝置螢幕、網路狀態等等的內容。

隨後就是各類工具了，讓我們在隨後的內容裡慢慢欣賞。而在平時的工作中，前端工程師用得最多的就是偵錯樣式和程式碼了，這些也是作為一個前端程式設計師必須要掌握的。

### 實時偵錯樣式

作為一個有經驗的前端程式設計師，當我們開發前端介面時，都會：

 1. 在瀏覽器上編寫 CSS 和 HTML
 2. 將編寫好的 CSS 和 HTML 複製到程式碼中
 3. 重新載入頁面，看修改完的頁面是否正確
 4. 如果不正確，重複 1~3

而當我們想檢視頁面上某個元素的 DOM 結構或者 CSS 時，我們可以點選開發者工具中的 Inspect 圖示，並在頁面上選擇相應的元素。我們還可以使用快捷鍵來選擇元素，Windows / Linux上使用 Shift + Ctrl + C，Mac OS 上使用 Command + Shift + C。如下圖所示：

![實時偵錯樣式](../images/inspect-styles.jpg)

我們還會發現工具欄中的 Elements 選單自動被選上了，這是因為我們要選擇的元素是屬於 Elements 下的。也因此，還可以在 Elements 中選擇 HTML程式碼，檢視它在頁面上的位置。它們兩者是互相對應的，當我們選擇一個元素時，會自動為我們選擇相應的元素。

編碼時，可以在左側的“元素區”編輯 HTML，右側的區域的“Styles”可以檢視元素的樣式，“Computed”可以檢視元素的拿模型，“Event Listeners”則可以檢視元素的監聽事件，等等的內容。由於 CSS 樣式存在一定的優化級，如：

 - 元素選擇器選擇越精確，優化級越高
 - 相同類型選擇器制定的樣式，越靠後的優先順序越高

因而在複雜的前端項目裡，我們看到右側的樣式區域特別複雜，一層巢狀一層，如上圖中的右側區域。有些時候，是因為我們想共用一些樣式；有些時候，是因為在修改時，我們擔心影響其他區域，而使用更精確的選擇器。不幸的是，在一些早期的程式碼裡，我們還會看到在很多的地方里寫了``!important``這樣的程式碼。

### 實時偵錯程式碼

與靜態語言相比，JavaScript的偵錯就相對比較簡單一些，我們可以在執行的時候偵錯程式碼。只需要在瀏覽器的相就部分打個斷點，再執行相應的操作，就可以等程式碼掉到這個坑裡。如下是 Chrome 瀏覽器進行程式碼偵錯時的截圖：

![Chrome 偵錯](../images/realtime-debug.png)

從工具欄中的 Sources 就可以進行到這個介面。左側的部分會顯示當前頁面的程式碼及資源，如 HTML、CSS、JavaScript，還有圖片等。這些內容都是由當前頁面的 html 載入來決定的，如果是單頁面應用，則會是所有的資源。

如上圖所示，偵錯時，我們只需要：

 - 選擇相應的源碼檔案
 - 在中間區域在相應的行數上打上斷點
 - 再重新整理頁面就可以進入偵錯

這時，我們只需要將游標，移動到正在偵錯的變數上，就可以實時預覽這個值。我們還能在 Console 裡對這些值進行實時的處理，當業務邏輯比較複雜時，這個功能就特別有幫助——實時的編寫程式碼。

移動裝置偵錯
---

從幾年前開始，越來越多的公司將 Mobile First 作為第一優先順序的技術轉型。這時對於前端而言，我們需要響應式設計，我們需要處理不同的解析度，我們需要處理不同的作業系統，我們需要編寫更多的程式碼，以及見證更多的 Bug 誕生。

越來越多的移動端功能需要開發時，能提供好的開發體驗的工具就會越受歡迎，於是各個瀏覽器產商就提供了更好的移動開發功能：

 - 可以在瀏覽器上模擬真機的解析度、User Agent 等等基本的資訊
 - 提供介面來連線真機，並允許開發者在上面進行偵錯。

在瀏覽器上模擬的特點是，我們可以一次開發匹配多種解析度的裝置，但是並不能發現一些真機才存在的 Bug——如 Android 裝置的後退鍵。而真機的缺點則是，需要一個個裝置的進行偵錯。因此，理想的開發模式是：**先在瀏覽器進行響應式設計，隨後在真機上進行測試**。

### 模擬真機：裝置模擬器

為了適配不同分配率的移動裝置時，我們會使用 media query 進行響應式設計。並制定出一些螢幕的解析度，並以此來區分三種類型的裝置：計算機、平板、手機，如針對於計算機的畫素應該是大於 1024 的。

螢幕大小隻是用來判斷的一部分依據，還有一部分是通過 User Agent。它包含客戶端瀏覽器的相關資訊，如所使用的作業系統及版本、CPU 類型、瀏覽器及版本、瀏覽器渲染引擎等等。如下是我使用瀏覽器時，瀏覽器發出的 User Agent：

``Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/56.0.2924.87 Mobile Safari/537.36``

那麼，我們就可以根據這些資訊，最終確定裝置是桌面裝置，還是移動裝置，是 Android 手機，還是 iOS 手機。

我們所需要的就是，開啟開發者工具，然後選擇圖示中的裝置工具欄，就有如下的圖：

![Chrome 移動裝置](../images/chrome-mobile.jpg)

在使用它進行偵錯時，我們可以自定義螢幕大小，也可以選擇一些主流的裝置進行響應式設計，如iPhone。除此，我們還能測試不同的網路環境，如 4G、2G 的下載速度，又或者是離線情況下使用。

如果我們只是適配不同的裝置螢幕，那麼我們使用這個工具就夠了。而當我們需要做一些裝置相關的邏輯時，我們還需要使用真機來進行偵錯。

### 真機偵錯：Device Inspect

過去的很長一段時間裡，我一直都不需要真機偵錯這種功能——因為只是進行響應式設計。當我們在項目上遇到一系列關於 Android 返回鍵的 Bug 時，我們就不得不使用裝置進行偵錯。

對於移動單頁面應用來說，我們需要建立一系列的 UI、事件和行為。理論上，我們需要保證使用者可以在全屏的情況下，像一個移動應用一樣執行。除了一般應用的功能，我們還需要在頁面上建立返回鍵來返回到上一個頁面。這時，難免的我們就需要處理 Android 裝置上的這種 Bug。於是，我們需要：

 - 判斷裝置是不是 Android 裝置
 - 判斷按下的是裝置上的返回鍵，而不是瀏覽器上的返回
 - 如果是裝置上的返回鍵，則進行特殊處理，避免使用者退出應用

這時我們就需要連線上真機，並在瀏覽器上開啟 ``chrome://inspect/``，進入移動裝置的偵錯介面，並在手機 Chrome 瀏覽器上敲入要偵錯的網址：

[https://phodal.github.io/motree/](https://phodal.github.io/motree/)

![Inspect Devices](../images/inspect-devices.jpg)

隨後，我們就可以像在桌面瀏覽器的偵錯一樣，對程式碼進行偵錯。

同理，對於 Safari 瀏覽器來說也是類似的。除此，Safari 瀏覽器可以支援更有意思的偵錯，如果正在開發的應用是混合應用，Safari 也可以對此進行偵錯。開發混合應用時，我們往往會遇到一些奇怪的 Bug，這時我們就需要它了。

![Safari Simulator](../images/safari-hybird.jpg)

網路偵錯
---

在前後端 Web 應用開發的初期，前後端進行互動是一種痛苦的事，會遇到各種意味之外的錯誤。我們需要檢視參數傳遞過程中是否漏傳了，是否傳入了一些錯誤的值，是否是跨域問題等等。

### 網路偵錯

Chrome 裡的開發者工具中的 Network 不僅可以檢視頁面的加速速度，還可以看我們發出的請求的詳細資訊、返回結果的詳細資訊，以及我們傳送給服務端的資料。如下圖所示：

![Debug網路](../images/debug-network.jpg)

在圖裡，我們可以清晰地看到請求的 URL、返回的狀態碼，它可以讓我們知道發出的請求是對的、返回的狀態也是對的。如果我們發出的請求是對的，而返回的內容是錯的，那麼我們可以相信這是服務端的錯誤。如果返回的狀態碼是錯的，我們也可以看出到底是服務端的錯誤，還是客戶端的錯誤。

設計表單時，我們可以看到它發出的參數是否是正確的。

![表單資料](../images/form-data.png)

這一來一往，我們就知道到底是哪個地方的問題。

### 使用外掛

除了上面說到的工具，我們還可以在 Chrome 應用商店裡找到更多、更合適的工具。我在我的 GitHub 上維護了，我常用的一些工具：[https://github.com/phodal/toolbox](https://github.com/phodal/toolbox)，我整理了平時使用的外掛在上面。

讓我推薦兩個簡單的工具，一個是 Postman，用於偵錯 API 用的：

![Postman](../images/postman.png)

還有一個是 Google 的 Page Speed，可以幫助我們優化網路：

![PageSpeed 結果](../images/pagespeed-reseult.png)

小結
---

在這一章裡介紹了使用 Chrome 瀏覽器來偵錯的工具，這些在前端工程師的日常開發中非常有用。

除此，在 Chrome 瀏覽器裡還有一些額外的功能可以使用。如在 “Application”選單欄中，我們可以看到與應用相關的一些快取和儲存資訊。Chrome 瀏覽器裡，我們可以看到 Local Storage、Cookies、Session Storage、IndexedDB、Web SQL 等等的用於資料儲存的工具。編寫單頁面應用時，我們都需要在客戶端儲存一些資料，這時就需要用到這個工具。除此，還有 Google PWA 應用的一些相關屬性，Manifest、Service Workers。
